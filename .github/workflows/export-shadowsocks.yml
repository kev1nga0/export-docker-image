name: Export Shadowsocks Docker Image (amd64)

on:
  workflow_dispatch:

jobs:
  export:
    runs-on: ubuntu-latest

    steps:
      - name: Pull shadowsocks image (amd64)
        run: |
          set -e
          echo "Pulling shadowsocks/shadowsocks-libev..."
          docker pull --platform linux/amd64 shadowsocks/shadowsocks-libev:latest || \
          docker pull --platform linux/amd64 teddysun/shadowsocks-libev:latest

      - name: Detect image name
        run: |
          if docker image inspect shadowsocks/shadowsocks-libev:latest >/dev/null 2>&1; then
            echo "IMAGE=shadowsocks/shadowsocks-libev:latest" >> $GITHUB_ENV
          else
            echo "IMAGE=teddysun/shadowsocks-libev:latest" >> $GITHUB_ENV
          fi

      - name: Save image to tar
        run: |
          docker save -o shadowsocks-amd64.tar $IMAGE
          ls -lh shadowsocks-amd64.tar

      - name: Compress tar
        run: |
          gzip -f shadowsocks-amd64.tar
          ls -lh shadowsocks-amd64.tar.gz

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: shadowsocks-amd64-image
          path: shadowsocks-amd64.tar.gz
