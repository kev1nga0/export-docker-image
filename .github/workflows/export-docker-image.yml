name: 通用Docker镜像离线打包工作流
on:
  workflow_dispatch:
    inputs:
      image-repo:
        description: '镜像仓库地址（含用户名/仓库名，例：shadowsocks/shadowsocks-libev）'
        required: true
        type: string
      image-tag:
        description: '镜像标签（例：latest、v1.0.0）'
        required: true
        type: string
        default: 'latest'
      image-arch:
        description: '镜像架构（例：linux/amd64、linux/arm64）'
        required: true
        type: string
        default: 'linux/amd64'
      output-name:
        description: '输出文件前缀（例：shadowsocks、clash）'
        required: true
        type: string
        default: 'docker-image'

jobs:
  export-image:
    runs-on: ubuntu-latest
    steps:
      # 步骤1：拉取指定架构、指定版本的Docker镜像
      - name: 拉取目标Docker镜像
        run: |
          set -e
          echo "开始拉取镜像：${{ inputs.image-repo }}:${{ inputs.image-tag }}（架构：${{ inputs.image-arch }}）"
          docker pull --platform ${{ inputs.image-arch }} ${{ inputs.image-repo }}:${{ inputs.image-tag }}
          echo "镜像拉取成功！"

      # 步骤2：验证镜像是否存在，并存入环境变量
      - name: 检测镜像有效性
        run: |
          FULL_IMAGE="${{ inputs.image-repo }}:${{ inputs.image-tag }}"
          if docker image inspect $FULL_IMAGE >/dev/null 2>&1; then
            echo "镜像验证通过：$FULL_IMAGE"
            echo "FULL_IMAGE=$FULL_IMAGE" >> $GITHUB_ENV
          else
            echo "错误：镜像 $FULL_IMAGE 不存在！"
            exit 1
          fi

      # 步骤3：格式化架构名称（替换斜杠为连字符，避免路径错误）
      - name: 格式化架构名称
        run: |
          # 将 linux/amd64 转换为 linux-amd64
          FORMATTED_ARCH=$(echo "${{ inputs.image-arch }}" | tr '/' '-')
          echo "格式化后的架构名称：$FORMATTED_ARCH"
          echo "FORMATTED_ARCH=$FORMATTED_ARCH" >> $GITHUB_ENV

      # 步骤4：导出镜像为tar包（使用格式化后的架构名称）
      - name: 导出镜像为tar包
        run: |
          # 拼接文件名：前缀-格式化架构-标签.tar（例：clash-linux-amd64-latest.tar）
          TAR_FILENAME="${{ inputs.output-name }}-${{ env.FORMATTED_ARCH }}-${{ inputs.image-tag }}.tar"
          echo "开始导出镜像到：$TAR_FILENAME"
          docker save -o $TAR_FILENAME ${{ env.FULL_IMAGE }}
          ls -lh $TAR_FILENAME
          echo "TAR_FILENAME=$TAR_FILENAME" >> $GITHUB_ENV

      # 步骤5：压缩tar包
      - name: 压缩tar包（gzip）
        run: |
          echo "开始压缩文件：${{ env.TAR_FILENAME }}"
          gzip -f ${{ env.TAR_FILENAME }}
          GZ_FILENAME="${{ env.TAR_FILENAME }}.gz"
          ls -lh $GZ_FILENAME
          echo "GZ_FILENAME=$GZ_FILENAME" >> $GITHUB_ENV

      # 步骤6：上传离线镜像压缩包
      - name: 上传离线镜像压缩包
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.output-name }}-offline-image
          path: ${{ env.GZ_FILENAME }}
          retention-days: 90
          if-no-files-found: error
